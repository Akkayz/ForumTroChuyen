@model List<WebTroChuyen.Models.BaiViet>
@using WebTroChuyen.Models

@{
    ViewBag.Title = "BaiViet";
    Layout = "~/Views/Shared/_LayoutTrangChu.cshtml";
}

<div class="container bg-white" style="max-width: 1000px;">
    <div class="row">
        <div class="col-md-8">
            <section class="list-view">
                @foreach (var baiViet in ViewBag.DanhSachBaiViet)
                {
                    var userId = ViewBag.UserId;
                    var existingLike = null as Like;
                    foreach (var like in baiViet.Likes)
                    {
                        if (like.UserID == userId)
                        {
                            existingLike = like;
                            break;
                        }
                    }
                    var existingDislike = null as Dislike;
                    foreach (var dislike in baiViet.Dislikes)
                    {
                        if (dislike.UserID == userId)
                        {
                            existingDislike = dislike;
                            break;
                        }
                    }
                    var existingLikeCss = existingLike != null ? "red" : "blue";

                    var existingDislikeCss = existingDislike != null ? "red" : "blue";

                    <article class="border p-3 mb-3">
                        <div class="account-frame d-flex" style="max-height: 40px;">
                            <img src="~/Images/UserAvatar/@baiViet.NguoiDung.Avatar" width="40" height="40" alt="Avatar" class="avatar me-3">
                            <div class="user-info">
                                <h6 class="mb-0 text-opacity">@baiViet.NguoiDung.TenNguoiDung</h6>
                                <span class="timestamp text-opacity">@CalculateTimeDifference(baiViet.NgayDang)</span>
                            </div>
                            <div class="user-level d-flex align-items-center justify-content-center rounded bg-primary text-white" style="width: 60px; height: 30px;">
                                <div class="level-info">
                                    <span class="user-level-text">Cấp @baiViet.NguoiDung.CapDo</span>
                                </div>
                            </div>
                            <span class="category text-opacity">@baiViet.DanhMuc.TenDanhMuc</span>
                        </div>

                        <h2 class="mt-3">@baiViet.TieuDe</h2>
                        <p>@baiViet.NoiDung</p>

                        <figure class="mt-3">
                            <img src="~/Images/UserImagePost/@baiViet.HinhAnh" alt="Mô tả ảnh" class="img-fluid">
                        </figure>

                        <section class="post-footer mt-3">
                            <ul class="post-vote list-unstyled d-flex">
                                <!-- Trong phần tương ứng với nút like -->
                                <li class="post-vote-item me-4">
                                    <a href="#" class="post-vote-link" style="padding: 5px; box-shadow: 0 0 0 1px #e5e5e5; text-decoration: none; color: @existingLikeCss;" onclick="likeBaiViet(@baiViet.BaiVietID, @userId)">
                                        <i class="fa fa-thumbs-up"></i>
                                        <span class="post-vote-count" id="luotThich@baiViet.BaiVietID">@baiViet.LuotThich</span>
                                    </a>
                                </li>

                                <!-- Trong phần tương ứng với nút dislike -->
                                <li class="post-vote-item me-4">
                                    <a href="#" class="post-vote-link" style="padding: 5px; box-shadow: 0 0 0 1px #e5e5e5; text-decoration: none;" onclick="dislikeBaiViet(@baiViet.BaiVietID, @userId)">
                                        <i class="fa fa-thumbs-down" id="dislikeButton@baiViet.BaiVietID" style="color: @existingDislikeCss;"></i>
                                        <span class="post-vote-count" id="luotKhongThich@baiViet.BaiVietID">@baiViet.LuotKhongThich</span>
                                    </a>
                                </li>

                                <li class="post-vote-item me-4">
                                    <a href="#" class="post-vote-link" style="padding: 5px; box-shadow: 0 0 0 1px #e5e5e5; text-decoration: none;">
                                        <i class="fa fa-comment"></i>
                                        <span class="post-vote-count">3</span>
                                    </a>
                                </li>
                                <li class="post-vote-item dropdown">
                                    <a href="#" class="post-vote-link dropdown-toggle" a="button" id="postActionsDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="padding: 5px; box-shadow: 0 0 0 1px #e5e5e5; text-decoration: none;">
                                        <i class="fa fa-ellipsis-h"></i>
                                    </a>
                                    <ul class="dropdown-menu" aria-labelledby="postActionsDropdown">
                                        <li><span class="dropdown-item">Báo vi phạm</span></li>
                                    </ul>
                                </li>
                            </ul>
                        </section>
                    </article>
                }
            </section>
        </div>
        <div class="col-md-4">
            <h2>Top thành viên</h2>
            <ul class="list-group top-members-list">
                @for (var i = 0; i < ViewBag.TopThanhVien.Count; i++)
                {
                    var thanhVien = ViewBag.TopThanhVien[i];
                    <li class="list-group-item top-member d-flex">
                        <div class="rank me-3"><h3 style="max-height: 30px; color: #00ffff;">@($"{i + 1:00}")</h3></div>
                        <div class="user-image">
                            <img src="~/Images/UserAvatar/@thanhVien.Avatar" width="60" height="60" alt="Ảnh thành viên @(i + 1)">
                        </div>
                        <div class="user-info d-flex align-items-center">
                            <div class="user-details">
                                <h5 class="user-name text-truncate">@thanhVien.TenNguoiDung</h5>
                                <span class="user-level d-flex align-items-center justify-content-center rounded bg-primary text-white" style="width: 60px; max-height: 30px;">Cấp @thanhVien.CapDo</span>
                            </div>
                        </div>
                    </li>
                }
            </ul>
        </div>
    </div>
</div>
@helper CalculateTimeDifference(DateTime thoiGianGui)
{
    var currentTime = DateTime.Now;
    var timeDifference = currentTime - thoiGianGui;

    string result;

    if (timeDifference.TotalMinutes < 1)
    {
        result = "Vừa xong";
    }
    else if (timeDifference.TotalMinutes < 60)
    {
        result = $"{(int)timeDifference.TotalMinutes} phút trước";
    }
    else if (timeDifference.TotalHours < 24)
    {
        result = $"{(int)timeDifference.TotalHours} giờ trước";
    }
    else
    {
        var days = (int)timeDifference.TotalDays;
        result = $"Cách đây {days} ngày trước";
    }

    @result
}
<script>
    function likeBaiViet(baiVietID, userID) {
        $.ajax({
            url: '@Url.Action("LikeBaiViet", "BaiViet")',
            type: 'POST',
            data: { baiVietID: baiVietID, userID: userID },
            success: function (result) {
                if (result.success) {
                    $(`#likeButton${baiVietID}`).css('color', result.daLike ? 'red' : 'blue');
                    $(`#luotThich${baiVietID}`).text(result.luotThich);
                }
            },
            error: function (error) {
                console.error(error);
            }
        });
    }
    function dislikeBaiViet(baiVietID, userID) {
    $.ajax({
        url: '@Url.Action("DislikeBaiViet", "BaiViet")',
        type: 'POST',
        data: { baiVietID: baiVietID, userID: userID },
        success: function (result) {
            if (result.success) {
                $(`#dislikeButton${baiVietID}`).css('color', result.daDislike ? 'red' : 'blue');
                $(`#luotKhongThich${baiVietID}`).text(result.luotKhongThich);
            }
        },
        error: function (error) {
            console.error(error);
        }
    });
}
</script>